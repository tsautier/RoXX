{% extends "base.html" %}

{% block title %}Auth Provider Logs - RoXX{% endblock %}

{% block content %}
<div class="container" style="max-width: 1400px; margin: 2rem auto; padding: 0 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1 style="margin: 0; font-size: 2rem; color: #1e293b;">Authentication Provider Logs</h1>
            <p style="color: #64748b; margin-top: 0.5rem;">Admin panel authentication debug logs</p>
        </div>
        <div style="display: flex; gap: 0.75rem;">
            <button onclick="toggleAutoRefresh()" id="refreshBtn" class="btn btn-outline">
                <span id="refreshIcon">‚è∏Ô∏è</span> Auto-refresh
            </button>
            <button onclick="clearLogs()" class="btn btn-outline" style="color: #ef4444; border-color: #ef4444;">
                üóëÔ∏è Clear Logs
            </button>
        </div>
    </div>

    <!-- Stats Panel -->
    <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div class="card" style="padding: 1.5rem; text-align: center;">
            <div style="font-size: 2rem; font-weight: 700; color: #3b82f6;" id="totalLogs">0</div>
            <div style="color: #64748b; font-size: 0.9rem; margin-top: 0.25rem;">Total Logs</div>
        </div>
        <div class="card" style="padding: 1.5rem; text-align: center;">
            <div style="font-size: 2rem; font-weight: 700; color: #10b981;" id="successCount">0</div>
            <div style="color: #64748b; font-size: 0.9rem; margin-top: 0.25rem;">Successful</div>
        </div>
        <div class="card" style="padding: 1.5rem; text-align: center;">
            <div style="font-size: 2rem; font-weight: 700; color: #ef4444;" id="failureCount">0</div>
            <div style="color: #64748b; font-size: 0.9rem; margin-top: 0.25rem;">Failed</div>
        </div>
        <div class="card" style="padding: 1.5rem; text-align: center;">
            <div style="font-size: 2rem; font-weight: 700; color: #8b5cf6;" id="successRate">0%</div>
            <div style="color: #64748b; font-size: 0.9rem; margin-top: 0.25rem;">Success Rate</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #475569;">Backend
                    Type</label>
                <select id="filterBackendType" onchange="applyFilters()" class="form-control">
                    <option value="">All Types</option>
                    <option value="ldap">LDAP</option>
                    <option value="saml">SAML</option>
                    <option value="radius">RADIUS</option>
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #475569;">Status</label>
                <select id="filterSuccess" onchange="applyFilters()" class="form-control">
                    <option value="">All</option>
                    <option value="true">Success</option>
                    <option value="false">Failure</option>
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #475569;">Username</label>
                <input type="text" id="filterUsername" onkeyup="applyFilters()" class="form-control"
                    placeholder="Search username...">
            </div>
        </div>
    </div>

    <!-- Logs Table -->
    <div class="card" style="overflow: hidden;">
        <div style="overflow-x: auto;">
            <table id="logsTable" style="width: 100%; border-collapse: collapse; min-width: 900px;">
                <thead style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                    <tr>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #475569; width: 160px;">
                            Timestamp</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #475569;">Backend</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #475569;">Username</th>
                        <th style="padding: 1rem; text-align: center; font-weight: 600; color: #475569; width: 80px;">
                            Status</th>
                        <th style="padding: 1rem; text-align: right; font-weight: 600; color: #475569; width: 100px;">
                            Duration</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #475569;">Details</th>
                    </tr>
                </thead>
                <tbody id="logsBody">
                    <tr>
                        <td colspan="6" style="padding: 2rem; text-align: center; color: #94a3b8;">
                            Loading logs...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let allLogs = [];
    let autoRefreshInterval = null;

    async function loadLogs() {
        try {
            const response = await fetch('/api/auth-providers/logs');
            const data = await response.json();
            allLogs = data.logs || [];
            updateStats(data.stats);
            applyFilters();
        } catch (error) {
            console.error('Error loading logs:', error);
            document.getElementById('logsBody').innerHTML = `
            <tr><td colspan="6" style="padding: 2rem; text-align: center; color: #ef4444;">
                Error loading logs
            </td></tr>
        `;
        }
    }

    function updateStats(stats) {
        if (!stats) return;

        document.getElementById('totalLogs').textContent = stats.size || 0;
        document.getElementById('successCount').textContent = stats.total_successes || 0;
        document.getElementById('failureCount').textContent = stats.total_failures || 0;
        document.getElementById('successRate').textContent = (stats.success_rate || 0).toFixed(1) + '%';
    }

    function applyFilters() {
        const backendType = document.getElementById('filterBackendType').value;
        const success = document.getElementById('filterSuccess').value;
        const username = document.getElementById('filterUsername').value.toLowerCase();

        let filtered = allLogs;

        if (backendType) {
            filtered = filtered.filter(log => log.backend_type === backendType);
        }

        if (success !== '') {
            const successBool = success === 'true';
            filtered = filtered.filter(log => log.success === successBool);
        }

        if (username) {
            filtered = filtered.filter(log =>
                (log.username || '').toLowerCase().includes(username)
            );
        }

        renderLogs(filtered);
    }

    function renderLogs(logs) {
        const tbody = document.getElementById('logsBody');

        if (logs.length === 0) {
            tbody.innerHTML = `
            <tr><td colspan="6" style="padding: 2rem; text-align: center; color: #94a3b8;">
                No logs found
            </td></tr>
        `;
            return;
        }

        tbody.innerHTML = logs.map(log => {
            const timestamp = new Date(log.timestamp).toLocaleString('en-US', {
                month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit'
            });

            const statusIcon = log.success ? '‚úì' : '‚úó';
            const statusColor = log.success ? '#10b981' : '#ef4444';
            const statusBg = log.success ? '#d1fae5' : '#fee2e2';

            const backendColors = {
                'ldap': '#3b82f6',
                'saml': '#8b5cf6',
                'radius': '#f59e0b'
            };
            const backendColor = backendColors[log.backend_type] || '#64748b';

            const duration = log.duration_ms ? log.duration_ms.toFixed(1) + ' ms' : '-';

            return `
            <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 1rem; color: #64748b; font-size: 0.85rem; font-family: monospace;">${timestamp}</td>
                <td style="padding: 1rem;">
                    <span style="background: ${backendColor}20; color: ${backendColor}; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.85rem; font-weight: 500;">
                        ${log.backend_type || 'N/A'}
                    </span>
                    ${log.backend_name ? `<div style="color: #94a3b8; font-size: 0.8rem; margin-top: 0.25rem;">${log.backend_name}</div>` : ''}
                </td>
                <td style="padding: 1rem; font-weight: 500; color: #1e293b;">${log.username || 'N/A'}</td>
                <td style="padding: 1rem; text-align: center;">
                    <span style="background: ${statusBg}; color: ${statusColor}; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: 600; font-size: 1.1rem;">
                        ${statusIcon}
                    </span>
                </td>
                <td style="padding: 1rem; text-align: right; font-family: monospace; color: #64748b; font-size: 0.9rem;">${duration}</td>
                <td style="padding: 1rem; color: #64748b; font-size: 0.9rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis;" title="${log.details || ''}">${log.details || '-'}</td>
            </tr>
        `;
        }).join('');
    }

    function toggleAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            document.getElementById('refreshIcon').textContent = '‚ñ∂Ô∏è';
        } else {
            autoRefreshInterval = setInterval(loadLogs, 3000);
            document.getElementById('refreshIcon').textContent = '‚è∏Ô∏è';
            loadLogs(); // Load immediately
        }
    }

    async function clearLogs() {
        if (!confirm('Clear all authentication logs?')) {
            return;
        }

        try {
            const response = await fetch('/api/auth-providers/logs', {
                method: 'DELETE'
            });

            const data = await response.json();
            if (data.success) {
                loadLogs();
            }
        } catch (error) {
            console.error('Error clearing logs:', error);
            alert('Error clearing logs');
        }
    }

    // Load logs on page load and start auto-refresh
    loadLogs();
    toggleAutoRefresh(); // Start auto-refresh by default
</script>
{% endblock %}