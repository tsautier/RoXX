{% extends "layout.html" %}

{% block title %}Dashboard - RoXX{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem; color: var(--primary-color);">Dashboard</h1>

<!-- Stats Row -->
<div class="row mb-4">
    <!-- OS -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            System ({{ os_type }})</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ cpu.percent }}% CPU</div>
                        <div class="text-xs text-muted">{{ cpu.count }} Cores</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-server fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RAM -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Memory</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ memory.percent }}%</div>
                        <div class="text-xs text-muted">{{ memory.used }}GB / {{ memory.total }}GB</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-memory fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Disk -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Disk (/)</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ disk.percent }}%</div>
                        <div class="text-xs text-muted">{{ disk.free }}GB Free</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-hdd fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Uptime -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Uptime</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">{{ uptime }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-clock fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Two Column Grid: System Status + User Management -->
<div class="dashboard-grid">
    <!-- Left: RADIUS Status -->
    <div class="status-card">
        <h3>FreeRADIUS Status</h3>

        <!-- Large UP/DOWN Badge -->
        <div class="status-badge-large {% if radius_status != 'UP' %}down{% endif %}">
            <div class="status-icon">{% if radius_status == 'UP' %}✓{% else %}✕{% endif %}</div>
            <div class="status-text">{{ radius_status }}</div>
        </div>

        <p class="text-center mt-3 text-muted">Core Authentication Service</p>
    </div>

    <!-- Right: User Management -->
    <div class="user-table-container">
        <h3>User Management</h3>
        <table class="user-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% if recent_users %}
                {% for user in recent_users %}
                <tr>
                    <td style="font-weight: 600;">{{ user.username }}</td>
                    <td>{{ user.role }}</td>
                    <td>
                        <span class="status-badge">{{ user.status }}</span>
                    </td>
                    <td>{{ user.last_login }}</td>
                    <td>
                        <button class="btn-action" onclick="editUser('{{ user.username }}')">Edit</button>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; color: var(--text-light);">No users found</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Live Logs Section -->
<div class="log-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="margin: 0;">Live Logs</h3>
        <div style="font-size: 0.9rem; font-weight: 600;">
            <span id="connectionStatus" style="color: #f59e0b;">Connecting...</span>
        </div>
    </div>

    <div id="logConsole"
        style="background: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', 'Monaco', monospace; padding: 1rem; border-radius: var(--radius-md); height: 400px; overflow-y: auto; font-size: 0.9rem; white-space: pre-wrap; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);">
        <div style="color: #666; font-style: italic;">Waiting for logs...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const logConsole = document.getElementById('logConsole');
    const statusSpan = document.getElementById('connectionStatus');
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/logs`;

    function connect() {
        const ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            statusSpan.textContent = '● Live';
            statusSpan.style.color = '#10B981'; // Green
            logConsole.innerHTML = ''; // Clear initial message
        };

        ws.onmessage = (event) => {
            const line = document.createElement('div');
            line.textContent = event.data;

            // Enhanced color highlighting based on log level
            if (event.data.includes('[Info]') || event.data.includes('SUCCESS')) {
                line.style.color = '#10B981'; // Green
            } else if (event.data.includes('[Warn]') || event.data.includes('WARNING')) {
                line.style.color = '#F59E0B'; // Orange
            } else if (event.data.includes('[Error]') || event.data.includes('FAILED')) {
                line.style.color = '#EF4444'; // Red
            } else if (event.data.includes('Access-Accept')) {
                line.style.color = '#10B981';
            } else if (event.data.includes('Access-Reject')) {
                line.style.color = '#EF4444';
            }

            logConsole.appendChild(line);
            logConsole.scrollTop = logConsole.scrollHeight; // Auto-scroll
        };

        ws.onclose = () => {
            statusSpan.textContent = '○ Disconnected (Reconnecting...)';
            statusSpan.style.color = '#EF4444';
            setTimeout(connect, 2000);
        };

        ws.onerror = (err) => {
            console.error('WebSocket error:', err);
            ws.close();
        };
    }

    function editUser(username) {
        window.location.href = `/admins`;
    }

    // Smooth scroll to logs when clicking Logs tab (handled by sidebar now via ID if needed, or direct link)
    // Sidebar link is /logs-view or similar, so this listener might be redundant but keeping for compatibility
    if (window.location.hash === '#logs') {
        document.querySelector('.log-section').scrollIntoView({ behavior: 'smooth' });
    }

    connect();
</script>
{% endblock %}