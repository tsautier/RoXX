{% extends "layout.html" %}

{% block title %}Dashboard - RoXX{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem; color: var(--primary-color);">Dashboard</h1>

<!-- Two Column Grid: System Status + User Management -->
<div class="dashboard-grid">
    <!-- Left: System Status -->
    <div class="status-card">
        <h3>System Status</h3>

        <!-- Large UP/DOWN Badge -->
        <div class="status-badge-large {% if radius_status != 'UP' %}down{% endif %}">
            <div class="status-icon">{% if radius_status == 'UP' %}‚úì{% else %}‚úï{% endif %}</div>
            <div class="status-text">{{ radius_status }}</div>
        </div>

        <!-- Info Items -->
        <div class="info-items">
            <div class="info-item">
                <div class="info-icon">üîê</div>
                <div>
                    <div class="info-label">FreeRADIUS</div>
                </div>
                <div class="info-value">{{ radius_status }}</div>
            </div>

            <div class="info-item">
                <div class="info-icon os">üêß</div>
                <div>
                    <div class="info-label">OS</div>
                </div>
                <div class="info-value">{{ os_type }}</div>
            </div>

            <div class="info-item">
                <div class="info-icon" style="background: #8b5cf6;">‚è±Ô∏è</div>
                <div>
                    <div class="info-label">Uptime</div>
                </div>
                <div class="info-value">{{ uptime }}</div>
            </div>
        </div>
    </div>

    <!-- Right: User Management -->
    <div class="user-table-container">
        <h3>User Management</h3>
        <table class="user-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% if recent_users %}
                {% for user in recent_users %}
                <tr>
                    <td style="font-weight: 600;">{{ user.username }}</td>
                    <td>{{ user.role }}</td>
                    <td>
                        <span class="status-badge">{{ user.status }}</span>
                    </td>
                    <td>{{ user.last_login }}</td>
                    <td>
                        <button class="btn-action" onclick="editUser('{{ user.username }}')">Edit</button>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; color: var(--text-light);">No users found</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Live Logs Section -->
<div class="log-section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="margin: 0;">Live Logs</h3>
        <div style="font-size: 0.9rem; font-weight: 600;">
            <span id="connectionStatus" style="color: #f59e0b;">Connecting...</span>
        </div>
    </div>

    <div id="logConsole"
        style="background: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', 'Monaco', monospace; padding: 1rem; border-radius: var(--radius-md); height: 400px; overflow-y: auto; font-size: 0.9rem; white-space: pre-wrap; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);">
        <div style="color: #666; font-style: italic;">Waiting for logs...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const logConsole = document.getElementById('logConsole');
    const statusSpan = document.getElementById('connectionStatus');
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/logs`;

    function connect() {
        const ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            statusSpan.textContent = '‚óè Live';
            statusSpan.style.color = '#10B981'; // Green
            logConsole.innerHTML = ''; // Clear initial message
        };

        ws.onmessage = (event) => {
            const line = document.createElement('div');
            line.textContent = event.data;

            // Enhanced color highlighting based on log level
            if (event.data.includes('[Info]') || event.data.includes('SUCCESS')) {
                line.style.color = '#10B981'; // Green
            } else if (event.data.includes('[Warn]') || event.data.includes('WARNING')) {
                line.style.color = '#F59E0B'; // Orange
            } else if (event.data.includes('[Error]') || event.data.includes('FAILED')) {
                line.style.color = '#EF4444'; // Red
            } else if (event.data.includes('Access-Accept')) {
                line.style.color = '#10B981';
            } else if (event.data.includes('Access-Reject')) {
                line.style.color = '#EF4444';
            }

            logConsole.appendChild(line);
            logConsole.scrollTop = logConsole.scrollHeight; // Auto-scroll
        };

        ws.onclose = () => {
            statusSpan.textContent = '‚óã Disconnected (Reconnecting...)';
            statusSpan.style.color = '#EF4444';
            setTimeout(connect, 2000);
        };

        ws.onerror = (err) => {
            console.error('WebSocket error:', err);
            ws.close();
        };
    }

    function editUser(username) {
        window.location.href = `/admins`;
    }

    // Smooth scroll to logs when clicking Logs tab (handled by sidebar now via ID if needed, or direct link)
    // Sidebar link is /logs-view or similar, so this listener might be redundant but keeping for compatibility
    if (window.location.hash === '#logs') {
        document.querySelector('.log-section').scrollIntoView({ behavior: 'smooth' });
    }

    connect();
</script>
{% endblock %}